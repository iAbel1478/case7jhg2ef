<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>UVA SDS • Lanternfly Image Uploader & Gallery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --uva-navy: #232D4B;
            --uva-orange: #E57200;
            --uva-blue: #007BAC;
            --gray-50: #fafafa;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
        }
        
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, 'Helvetica Neue', Helvetica;
            background: var(--gray-50);
            color: #0f172a;
        }
        
        header {
            background: var(--uva-navy);
            color: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .brand {
            display: flex;
            gap: .6rem;
            align-items: center;
            font-weight: 700;
            letter-spacing: .2px;
        }
        
        .pill {
            background: var(--uva-orange);
            color: #111827;
            font-weight: 800;
            padding: .15rem .5rem;
            border-radius: .5rem;
            font-size: .8rem;
        }
        
        main {
            max-width: 980px;
            margin: 1rem auto;
            padding: 0 1rem;
        }
        
        .card {
            background: #fff;
            border-radius: .5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,.1);
            margin-bottom: 1.5rem;
        }
        
        .controls {
            display: flex;
            gap: .75rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        input[type="file"] {
            padding: .5rem;
            border: 2px dashed var(--gray-200);
            border-radius: .25rem;
            flex: 1;
            min-width: 200px;
        }
        
        button {
            background: var(--uva-blue);
            color: #fff;
            border: none;
            padding: .6rem 1.2rem;
            border-radius: .25rem;
            font-weight: 600;
            cursor: pointer;
            transition: background .2s;
        }
        
        button:hover {
            background: #005a82;
        }
        
        button.secondary {
            background: var(--gray-600);
        }
        
        .row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .item {
            border: 1px solid var(--gray-200);
            border-radius: .25rem;
            overflow: hidden;
        }
        
        .thumb {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .cap {
            padding: .5rem;
            font-size: .8rem;
            color: var(--gray-600);
            word-break: break-all;
        }
        
        .muted {
            color: var(--gray-600);
            font-size: .9rem;
        }
        
        .note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: .25rem;
            padding: .75rem;
            margin: 1rem 0;
            font-size: .9rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <span>UVA SDS • Lanternfly Field Images</span>
            <span class="pill">DEMO</span>
        </div>
        <div class="muted">Public gallery (read) • Authenticated upload (write)</div>
    </header>
    
    <main>
        <!-- Upload Card -->
        <section class="card">
            <h3>Upload an image</h3>
            <div class="note">
                Images will be stored in the Azure Blob container (public-read). Uploads require server credentials; viewing is public.
            </div>
            <div class="controls">
                <input type="file" id="f" accept="image/*" capture="environment">
                <button id="uploadBtn" onclick="sendUpload()">Upload</button>
                <button class="secondary" onclick="document.getElementById('f').value=''">Reset</button>
                <span id="uploadStatus" class="muted" aria-live="polite"></span>
            </div>
        </section>
        
        <!-- Gallery Card -->
        <section class="card">
            <div class="row" style="justify-content: space-between;">
                <h3 style="margin: 0;">Gallery</h3>
                <div class="row muted">
                    <span id="count">0 images</span>
                    <button class="secondary" onclick="loadGallery()" title="Refresh gallery">Refresh</button>
                </div>
            </div>
            <div id="galleryNote" class="note" style="display: none;"></div>
            <div id="grid" class="grid"></div>
        </section>
    </main>
    
    <script>
        const grid = document.getElementById('grid');
        const countEl = document.getElementById('count');
        const noteEl = document.getElementById('galleryNote');
        const fileInput = document.getElementById('f');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusEl = document.getElementById('uploadStatus');
        
        let uploading = false;
        
        function setUploading(state) {
            uploading = state;
            uploadBtn.disabled = state;
            uploadBtn.textContent = state ? 'Uploading...' : 'Upload';
            statusEl.textContent = state ? 'Please wait...' : '';
        }
        
        async function sendUpload() {
            if (uploading || !fileInput.files[0]) return;
            
            setUploading(true);
            
            try {
                const fd = new FormData();
                fd.append('file', fileInput.files[0]);
                
                const r = await fetch('/api/v1/upload', {
                    method: 'POST',
                    body: fd
                });
                
                const j = await r.json();
                
                if (j.ok) {
                    statusEl.textContent = '✅ Uploaded successfully!';
                    fileInput.value = '';
                    await loadGallery();
                } else {
                    statusEl.textContent = `❌ Error: ${j.error}`;
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = `❌ Upload error: ${err.message}`;
            } finally {
                setUploading(false);
            }
        }
        
        function renderGallery(urls) {
            grid.innerHTML = '';
            
            if (!Array.isArray(urls) || urls.length === 0) {
                countEl.textContent = '0 images';
                noteEl.style.display = 'block';
                noteEl.textContent = 'No images yet. Upload one above.';
                return;
            }
            
            noteEl.style.display = 'none';
            countEl.textContent = `${urls.length} ${urls.length === 1 ? 'image' : 'images'}`;
            
            for (const u of urls) {
                const item = document.createElement('div');
                item.className = 'item';
                
                const img = document.createElement('img');
                img.className = 'thumb';
                img.src = u;
                img.alt = 'Lanternfly observation';
                
                const cap = document.createElement('div');
                cap.className = 'cap';
                cap.textContent = u.split('/').pop() || u;
                
                item.appendChild(img);
                item.appendChild(cap);
                grid.appendChild(item);
            }
        }
        
        async function loadGallery() {
            try {
                const r = await fetch('/api/v1/gallery');
                const j = await r.json();
                
                if (j.ok) {
                    renderGallery(j.gallery);
                } else {
                    noteEl.style.display = 'block';
                    noteEl.textContent = `Error loading gallery: ${j.error}`;
                }
            } catch (err) {
                console.error(err);
                noteEl.style.display = 'block';
                noteEl.textContent = `Gallery error: ${err.message}`;
            }
        }
        
        // Load gallery on page load
        loadGallery();
    </script>
</body>
</html>
